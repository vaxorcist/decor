<%# decor/app/views/data_transfers/show.html.erb - version 1.3 %>
<%# Owner data export / import page. %>
<%# Only reachable by logged-in owners (auth enforced globally by Authentication concern). %>
<%# %>
<%# Two sections: %>
<%#   Export — one-click CSV download of all the owner's computers and components. %>
<%#   Import — file upload form that calls POST /data_transfer/import. %>

<div class="max-w-3xl mx-auto">
  <h1 class="text-2xl font-semibold mb-6">Export / Import Your Data</h1>

  <%# ── Flash messages ──────────────────────────────────────────────────── %>
  <% if flash[:notice].present? %>
    <div class="mb-6 p-4 rounded border border-green-300 bg-green-50 text-green-800 text-sm">
      <%= flash[:notice] %>
    </div>
  <% end %>
  <% if flash[:alert].present? %>
    <div class="mb-6 p-4 rounded border border-red-300 bg-red-50 text-red-800 text-sm">
      <%= flash[:alert] %>
    </div>
  <% end %>

  <%# ── Export section ──────────────────────────────────────────────────── %>
  <div class="bg-white border border-stone-200 rounded p-6 mb-6">
    <h2 class="text-lg font-semibold mb-3">Export</h2>
    <p class="text-sm text-stone-600 mb-4">
      Download all of your computers and components as a CSV file.
      The file can be re-imported here or used as a backup.
    </p>
    <%# inline-flex items-center w-fit: constrains width to text (matching submit button), %>
    <%# and vertically centres the label the same way flex does on a submit element. %>
    <%# inline-block alone does not provide vertical centring. %>
    <%= link_to "Download CSV",
          export_data_transfer_path,
          class: "#{button_classes(style: :primary)} inline-flex items-center w-fit" %>
  </div>

  <%# ── Import section ──────────────────────────────────────────────────── %>
  <div class="bg-white border border-stone-200 rounded p-6 mb-6">
    <h2 class="text-lg font-semibold mb-3">Import</h2>
    <p class="text-sm text-stone-600 mb-1">
      Upload a CSV file in the format described below to add computers and
      components to your account.
    </p>
    <ul class="text-sm text-stone-600 mb-4 list-disc list-inside space-y-1">
      <li>Records that already exist (matched by serial number) are skipped — safe to re-import.</li>
      <li>If a referenced Computer Model, Component Type, Condition, or Run Status does not exist,
          the row is rejected and the entire import is rolled back.</li>
      <li>A component whose parent computer is not found is imported as a spare (not an error).</li>
      <li>The entire file is imported atomically — all rows succeed or none are saved.</li>
    </ul>

    <%# multipart: true is required for file uploads %>
    <%= form_with url: import_data_transfer_path, method: :post, multipart: true, class: "space-y-4" do |f| %>
      <div>
        <%= f.label :file, "CSV File", class: "block text-sm font-medium text-stone-700 mb-1" %>
        <%= f.file_field :file,
              accept: ".csv",
              required: true,
              class: "block w-full text-sm text-stone-600
                      file:mr-4 file:py-2 file:px-4 file:rounded
                      file:border-0 file:text-sm file:font-medium
                      file:bg-indigo-50 file:text-indigo-700
                      hover:file:bg-indigo-100" %>
        <p class="mt-1 text-xs text-stone-500">Maximum file size: 10 MB.</p>
      </div>
      <div>
        <%= f.submit "Import CSV", class: button_classes(style: :primary) %>
      </div>
    <% end %>
  </div>

  <%# ── CSV format reference ────────────────────────────────────────────── %>
  <div class="bg-white border border-stone-200 rounded p-6 mb-6">
    <h2 class="text-lg font-semibold mb-3">CSV Format</h2>
    <p class="text-sm text-stone-600 mb-4">
      Each row represents either one computer or one component,
      indicated by the <code class="font-mono bg-stone-100 px-1 rounded">record_type</code> column.
      Blank cells are allowed for optional fields.
    </p>

    <%# Column reference table — space-aligned, no pipe chars (plain-text-friendly) %>
    <div class="overflow-x-auto mb-4">
      <table class="min-w-full text-xs">
        <thead class="bg-stone-50">
          <tr>
            <th class="px-3 py-2 text-left font-medium text-stone-500 uppercase tracking-wider">Column</th>
            <th class="px-3 py-2 text-left font-medium text-stone-500 uppercase tracking-wider">Computer row</th>
            <th class="px-3 py-2 text-left font-medium text-stone-500 uppercase tracking-wider">Component row</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-stone-100 text-stone-700">
          <tr class="bg-white">
            <td class="px-3 py-2 font-mono">record_type</td>
            <td class="px-3 py-2"><span class="font-medium">Required.</span> Value: <code class="font-mono bg-stone-100 px-1 rounded">computer</code></td>
            <td class="px-3 py-2"><span class="font-medium">Required.</span> Value: <code class="font-mono bg-stone-100 px-1 rounded">component</code></td>
          </tr>
          <tr class="bg-stone-50">
            <td class="px-3 py-2 font-mono">computer_model</td>
            <td class="px-3 py-2"><span class="font-medium">Required.</span> Must match an existing model.</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
          </tr>
          <tr class="bg-white">
            <td class="px-3 py-2 font-mono">computer_order_number</td>
            <td class="px-3 py-2">Optional. Max 20 characters.</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
          </tr>
          <tr class="bg-stone-50">
            <td class="px-3 py-2 font-mono">computer_serial_number</td>
            <td class="px-3 py-2"><span class="font-medium">Required.</span> Max 20 characters.</td>
            <td class="px-3 py-2">Optional. Serial of the <em>parent computer</em> to attach this component to. Leave blank for spare components.</td>
          </tr>
          <tr class="bg-white">
            <td class="px-3 py-2 font-mono">computer_condition</td>
            <td class="px-3 py-2">Optional. Must match an existing condition.</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
          </tr>
          <tr class="bg-stone-50">
            <td class="px-3 py-2 font-mono">computer_run_status</td>
            <td class="px-3 py-2">Optional. Must match an existing run status.</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
          </tr>
          <tr class="bg-white">
            <td class="px-3 py-2 font-mono">computer_history</td>
            <td class="px-3 py-2">Optional. Free text.</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
          </tr>
          <tr class="bg-stone-50">
            <td class="px-3 py-2 font-mono">component_type</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
            <td class="px-3 py-2"><span class="font-medium">Required.</span> Must match an existing component type.</td>
          </tr>
          <tr class="bg-white">
            <td class="px-3 py-2 font-mono">component_order_number</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
            <td class="px-3 py-2">Optional. Max 20 characters.</td>
          </tr>
          <tr class="bg-stone-50">
            <td class="px-3 py-2 font-mono">component_serial_number</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
            <td class="px-3 py-2">Optional. Max 20 characters.</td>
          </tr>
          <tr class="bg-white">
            <td class="px-3 py-2 font-mono">component_condition</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
            <td class="px-3 py-2">Optional. Must match an existing component condition.</td>
          </tr>
          <tr class="bg-stone-50">
            <td class="px-3 py-2 font-mono">component_description</td>
            <td class="px-3 py-2 text-stone-400">Leave blank.</td>
            <td class="px-3 py-2">Optional. Free text.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <%# Example — matches the column order exactly so the user can use it as a template %>
    <h3 class="text-sm font-semibold text-stone-700 mb-2">Example</h3>
    <pre class="text-xs bg-stone-50 border border-stone-200 rounded p-3 overflow-x-auto text-stone-700">record_type,computer_model,computer_order_number,computer_serial_number,computer_condition,computer_run_status,computer_history,component_type,component_order_number,component_serial_number,component_condition,component_description
computer,PDP-11/70,AA-1234567-A,12345678,Completely original,Running,"Acquired 1978",,,,, 
component,,,12345678,,,, Memory Board,MB-001,,Working,"256KB core memory"
component,,,,,,, Memory Board,,,,Spare 256KB board</pre>
    <p class="mt-2 text-xs text-stone-500">
      The third row (spare component) has no <code class="font-mono">computer_serial_number</code> —
      it will be imported unattached.
    </p>
  </div>

  <%# Back button %>
  <div class="mt-2">
    <a href="#"
       data-controller="back"
       data-back-fallback-url-value="<%= owner_path(Current.owner) %>"
       data-action="click->back#go"
       class="text-sm text-stone-700 hover:text-stone-900">← Back</a>
  </div>
</div>
