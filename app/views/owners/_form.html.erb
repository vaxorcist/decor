<%# app/views/owners/_form.html.erb - version 1.8 %>
<%# Added password strength indicator %>
<%# Delete form uses plain HTML for reliability - no Rails/Turbo magic %>
<%# Danger zone is OUTSIDE main form to prevent nested forms %>
<%# Password generator uses Stimulus controller to create secure 16-character password %>
<%# Password fields are optional - leave blank to skip password change %>

<%= form_with model: owner, class: "space-y-4" do |f| %>
  <%= render "common/record_errors", record: owner %>

  <div>
    <%= f.label :user_name, class: "block text-sm font-medium text-stone-700" %>
    <%= f.text_field :user_name, class: field_classes %>
  </div>

  <div class="grid grid-cols-3 gap-4 items-end">
    <div class="col-span-2">
      <%= f.label :real_name, class: "block text-sm font-medium text-stone-700" %>
      <%= f.text_field :real_name, class: field_classes %>
    </div>
    <div>
      <%= f.label :real_name_visibility, "Visibility", class: "block text-sm font-medium text-stone-700" %>
      <%= f.select :real_name_visibility, Owner.real_name_visibilities.keys.map { |v| [v.titleize, v] }, {}, class: field_classes %>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-4 items-end">
    <div class="col-span-2">
      <%= f.label :email, class: "block text-sm font-medium text-stone-700" %>
      <%= f.email_field :email, class: field_classes %>
    </div>
    <div>
      <%= f.label :email_visibility, "Visibility", class: "block text-sm font-medium text-stone-700" %>
      <%= f.select :email_visibility, Owner.email_visibilities.keys.map { |v| [v.titleize, v] }, {}, class: field_classes %>
    </div>
  </div>

  <div class="grid grid-cols-3 gap-4 items-end">
    <div class="col-span-2">
      <%= f.label :country, class: "block text-sm font-medium text-stone-700" %>
      <%= f.select :country, Owner.countries_for_select, { include_blank: "Select a country" }, class: field_classes %>
    </div>
    <div>
      <%= f.label :country_visibility, "Visibility", class: "block text-sm font-medium text-stone-700" %>
      <%= f.select :country_visibility, Owner.country_visibilities.keys.map { |v| [v.titleize, v] }, {}, class: field_classes %>
    </div>
  </div>

  <div>
    <%= f.label :website, class: "block text-sm font-medium text-stone-700" %>
    <%= f.url_field :website, placeholder: "https://example.com", class: field_classes %>
  </div>

  <%# Password Change Section - Optional %>
  <%# User must provide current password to change to new password %>
  <%# Leave all password fields blank to update profile without changing password %>
  <div class="border-t border-stone-200 pt-4 mt-6" data-controller="password-generator">
    <h2 class="text-lg font-medium text-stone-900 mb-4">Change Password</h2>
    <p class="text-sm text-stone-600 mb-4">Leave blank if you don't want to change your password.</p>

    <div>
      <%= f.label :current_password, "Current Password", class: "block text-sm font-medium text-stone-700" %>
      <%= f.password_field :current_password, autocomplete: "current-password", class: field_classes %>
      <p class="text-xs text-stone-500 mt-1">Required to change your password</p>
    </div>

    <div>
      <%= f.label :password, "New Password", class: "block text-sm font-medium text-stone-700" %>
      <%= f.password_field :password, autocomplete: "new-password", class: field_classes, data: { password_generator_target: "password" } %>
      <button type="button" data-action="password-generator#generate" class="mt-2 text-sm text-indigo-600 hover:text-indigo-900 font-medium">
        Generate Secure Password
      </button>
      <div data-password-generator-target="strength" class="mt-2 text-sm hidden"></div>
      <p class="text-xs text-stone-500 mt-1">Minimum 12 characters with good strength. Using a generated password is recommended for security.</p>
    </div>

    <div>
      <%= f.label :password_confirmation, "Confirm New Password", class: "block text-sm font-medium text-stone-700" %>
      <%= f.password_field :password_confirmation, autocomplete: "new-password", class: field_classes, data: { password_generator_target: "confirmation" } %>
    </div>
  </div>

  <div class="flex gap-3">
    <%= f.submit class: button_classes(style: :primary) %>
    <%= link_to "Cancel", owner, class: button_classes(style: :secondary) %>
  </div>
<% end %>

<%# Danger Zone - Account Deletion %>
<%# CRITICAL: Outside main form (nested forms don't work in HTML) %>
<%# Uses plain HTML form - no Rails helpers, no Turbo, maximum reliability %>
<%# onsubmit confirmation fires once when button clicked %>
<% if owner.persisted? %>
  <div class="border-t border-red-200 pt-4 mt-6 bg-red-50 px-4 pb-4 rounded-lg">
    <h2 class="text-lg font-medium text-red-900 mb-2">Danger Zone</h2>
    <p class="text-sm text-red-700 mb-4">
      <strong>Warning:</strong> Account deletion is permanent and cannot be undone.
      All your computers and components will be permanently deleted.
    </p>

    <form action="<%= owner_path(owner) %>" method="post" class="space-y-3"
          onsubmit="return confirm('Are you absolutely sure? This action cannot be undone and will permanently delete your account and all your computers and components.');">
      <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
      <%= hidden_field_tag :_method, :delete %>

      <div>
        <label for="password" class="block text-sm font-medium text-red-900">Enter your password to confirm deletion</label>
        <input type="password" name="password" id="password" autocomplete="current-password"
               class="mt-1 block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm"
               placeholder="Your password" required>
      </div>

      <div class="flex gap-3">
        <button type="submit"
                class="inline-flex justify-center rounded-md border border-transparent bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
          Delete My Account Permanently
        </button>
        <span class="text-sm text-red-700 self-center">This action cannot be undone</span>
      </div>
    </form>
  </div>
<% end %>
